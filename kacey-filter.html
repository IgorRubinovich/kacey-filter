<!-- Imports for use when working on kacey-filter locally -->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/shadow-iframe/shadow-iframe.html">
<link rel="import" href="../../bower_components/map-search/map-search.html">
<link rel="import" href="../../bower_components/autocomplete/city-autocomplete.html">
<link rel="import" href="../../bower_components/ir-recursive/ir-recursive-menu.html">
 
<dom-module id="kacey-filter">
    <style>
        :host {
            display: block;
        }
        ir-filter-by {
            display: inline-block;
        }
    </style>

    <script src="../moment/min/moment-with-locales.min.js"></script>

    <template>

        <template is="dom-repeat" as="category">

        </template>

		<paper-toolbar>
			<span class="title">General Filters</span>
			<paper-icon-button on-tap="collapse" id="generalFilters" icon="expand-less"></paper-icon-button>
		</paper-toolbar>

		<div id="generalFiltersWrap">
			<ir-recursive-menu id="classifiedsCollection"
						  name="classifiedsCollection"
						  custom-class="custom"
						  top-label="Categories"
						  sub-label=" Sub Categories"
						  depth="1"
						  notify-url="{{category}}"
						  value="">
			</ir-recursive-menu>

			<paper-dropdown-menu  id="timeselector" class="custom" label="Time" no-label-float>
				<paper-menu class="dropdown-content">
					<paper-item>Today</paper-item>
					<paper-item>This week</paper-item>
					<paper-item>This month</paper-item>
				</paper-menu>
			</paper-dropdown-menu>

			<!--<paper-dropdown-menu  id="isFree" class="custom" label="Is Free" no-label-float>-->
				<!--<paper-menu class="dropdown-content">-->
					<!--<paper-item>Yes</paper-item>-->
					<!--<paper-item>No</paper-item>-->
				<!--</paper-menu>-->
			<!--</paper-dropdown-menu>-->

			<city-autocomplete  placeholder="?????"  id="city"  class="autocomplete" place="{{ place }}"></city-autocomplete>
		</div>
        <!--<input type="text"  placeholder="Enter a location" autocomplete="on">-->

		<paper-toolbar>
			<span class="title">Custom Filters</span>
			<paper-icon-button on-tap="collapse" id="customFilters" icon="expand-less"></paper-icon-button>
		</paper-toolbar>
		<div id="customFiltersWrap">
        <content>
		<p>Lorem Ipsum</p>
        </content>
		</div>
		
        <br><input type="submit" value="Search" on-tap="menuTap" class="btn"/>

        <app-location route="{{ route }}" use-hash-as-path></app-location>
        <app-route route="{{ route }}"></app-route>

		<map-search id="map"></map-search>

        <shadow-iframe on-action="onAction" id="content" url="{{ route.path }}" hijack-form> </shadow-iframe>




    </template>
</dom-module>


<script>
    (function(){
        Polymer({
            is: 'kacey-filter',
            properties: {
                data: {
                    type: Array,
                    value: []
                },
                selection: {
                    type: Array,
                    value: []
                },
                notifyUrl : {
                    type : String,
                    value : ""
                },
                valuePath : {
                    type : String,
                    value : 'id'
                },
                value : {
                    type : String,
                    value : "",
                    notify : true
                },
                city:{
                    type : String,
                    value : "",
                    notify : true
                },
                category:{
                    type : String,
                    notify : true,
                },
                extraFields:{
                    type: Array,
                    value: []
                },

				place : {
					type : Object,
					observer : '_placeChanged'
				},

                route : { 
					type : Object,
					notify: true
				}
            },

            menuTap : function(ev) {
//debugger;
//                ev.preventDefault();
                var url, el,text,city,category,filters, k, q,time, time2, time4;
                url = '/classifieds/category/';
                el = document.getElementById("city");
                time = document.getElementById("timeselector");
                time2 = time.value;

//            var time4 = 1467106708242;



                if(time2 == 'Today'){
                    time4 = moment().subtract(1, 'days');
                }
                else if(time2 == 'This week'){
                    time4 = moment().subtract(1, 'weeks');
                }
                else if(time2 == 'This month'){
                    time4 = moment().subtract(1, 'months');
                }
                else{
                    time4 = moment().subtract(1, 'years');
                }
                time4 = time4.format('X');



                text = el.value;
                var kr = text.match(/([^,]+)/);
                if(kr)
                    city = kr[0];
                else
                    city = null;

                category = this.$.classifiedsCollection.value;

                if(!kr){
                    k = url+'partial/'+ category+'/list';
                }
                else if(!category){
                    filters = { city : city,
                        pubDate: time4
                    };

                    var obj = Object.assign(filters, z);
                    console.log(obj);
                    q = JSON.stringify(filters);
                    k = '/classifieds/json/listbydate?q='+q;
                }

                else if(this.extraFields){
                    console.log(this.extraFields.length);
                    var b = this.extraFields;

                    var z = {};
                    var extra ="";
                    b.forEach(function(i){
//                        console.log(i);

                        z['q_'+i.name] = i.value;
                        var k =i.value;
                        if(i.name == 'minRooms'){extra = extra+'&rooms&q_rooms=>'+k+''}
                        if(i.name == 'maxRooms') extra = extra+'&rooms&q_rooms=<'+k+''



                    });


                    console.log(b);
                    k = url+'partial/'+ category+'/list/?fields=city&q_city='+city+'&pubDate&q_pubDate=>'+time4+extra;
                }
                else{
                    k = url+'partial/'+ category+'/list/?fields=city&q_city='+city+'&pubDate&q_pubDate=>'+time4;
                }

                this.set('route.path', k);

            },




            attached:function(){
//                this.set('route.path', '/');

                var extra =Polymer.dom(this).querySelectorAll('[filter-field]');

                console.log(extra);
                this.extraFields = extra;



            },
			
			_placeChanged : function () {
				if(this.place.name){
					this.$.map.displayCenter = this.place.geometry.location;
					this.$.map.map.fitBounds(this.place.geometry.viewport);
				}
			},
			
			collapse : function (ev) {
				var srcEl = ev.srcElement;
				if(srcEl.id == 'icon')
					srcEl = srcEl.parentElement;
				var srcElId = srcEl.id;
				var filterEl = document.getElementById(srcElId + 'Wrap');
				if(srcEl.icon == 'expand-less'){
					srcEl.icon = 'expand-more';
					filterEl.style.display = "none";
				} else {
					srcEl.icon = 'expand-less';
					filterEl.style.display = "inline";
				}
			}
        });
    }());
</script>
