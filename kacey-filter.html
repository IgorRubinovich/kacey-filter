<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/shadow-iframe/shadow-iframe.html">

<dom-module id="kacey-filter">
    <style>
        :host {
            display: block;
        }
        ir-filter-by {
            display: inline-block;
        }
    </style>

    <script src="../moment/min/moment-with-locales.min.js"></script>

    <template>

        <template is="dom-repeat" as="category">

        </template>

        <ir-recursive-menu id="classifiedsCollection"
                      name="classifiedsCollection"
                      custom-class="custom"
                      top-label="Categories"
                      sub-label=" Sub Categories"
                      depth="1"
                      notify-url="{{category}}"
                      value="">
        </ir-recursive-menu>

        <paper-dropdown-menu  id="timeselector" class="custom" label="Time" no-label-float>
            <paper-menu class="dropdown-content">
                <paper-item>Today</paper-item>
                <paper-item>This week</paper-item>
                <paper-item>This month</paper-item>
            </paper-menu>
        </paper-dropdown-menu>

        <!--<paper-dropdown-menu  id="isFree" class="custom" label="Is Free" no-label-float>-->
            <!--<paper-menu class="dropdown-content">-->
                <!--<paper-item>Yes</paper-item>-->
                <!--<paper-item>No</paper-item>-->
            <!--</paper-menu>-->
        <!--</paper-dropdown-menu>-->

        <city-autocomplete  placeholder="?????"  id="city"  class="autocomplete"></city-autocomplete>

        <!--<input type="text"  placeholder="Enter a location" autocomplete="on">-->

        <content>

        </content>

        <input type="submit" value="Search" on-tap="menuTap" class="btn"/>

        <app-location route="{{ route }}" use-hash-as-path></app-location>
        <app-route route="{{ route }}"></app-route>

		<map-search></map-search>

        <shadow-iframe on-action="onAction" id="content" url="{{ route.path }}" hijack-form> </shadow-iframe>




    </template>
</dom-module>


<script>
    (function(){
        Polymer({
            is: 'kacey-filter',
            properties: {
                data: {
                    type: Array,
                    value: []
                },
                selection: {
                    type: Array,
                    value: []
                },
                notifyUrl : {
                    type : String,
                    value : ""
                },
                valuePath : {
                    type : String,
                    value : 'id'
                },
                value : {
                    type : String,
                    value : "",
                    notify : true
                },
                city:{
                    type : String,
                    value : "",
                    notify : true
                },
                category:{
                    type : String,
                    notify : true,
                },
                extraFields:{
                    type: Array,
                    value: []
                },






                route : { type : Object, notify: true }
            },

            menuTap : function(ev) {
//debugger;
//                ev.preventDefault();
                var url, el,text,city,category,filters, k, q,time, time2, time4;
                url = '/classifieds/category/';
                el = document.getElementById("city");
                time = document.getElementById("timeselector");
                time2 = time.value;

//            var time4 = 1467106708242;



                if(time2 == 'Today'){
                    time4 = moment().subtract(1, 'days');
                }
                else if(time2 == 'This week'){
                    time4 = moment().subtract(1, 'weeks');
                }
                else if(time2 == 'This month'){
                    time4 = moment().subtract(1, 'months');
                }
                else{
                    time4 = moment().subtract(1, 'years');
                }
                time4 = time4.format('X');



                text = el.value;
                var kr = text.match(/([^,]+)/);
                if(kr)
                    city = kr[0];
                else
                    city = null;

                category = this.$.classifiedsCollection.value;

                if(!kr){
                    k = url+'partial/'+ category+'/list';
                }
                else if(!category){
                    filters = { city : city,
                        pubDate: time4
                    };

                    var obj = Object.assign(filters, z);
                    console.log(obj);
                    q = JSON.stringify(filters);
                    k = '/classifieds/json/listbydate?q='+q;
                }

                else if(this.extraFields){
                    console.log(this.extraFields.length);
                    var b = this.extraFields;

                    var z = {};
                    var extra ="";
                    b.forEach(function(i){
//                        console.log(i);

                        z['q_'+i.name] = i.value;
                        var k =i.value;
                        if(i.name == 'minRooms'){extra = extra+'&rooms&q_rooms=>'+k+''}
                        if(i.name == 'maxRooms') extra = extra+'&rooms&q_rooms=<'+k+''



                    });


                    console.log(b);
                    k = url+'partial/'+ category+'/list/?fields=city&q_city='+city+'&pubDate&q_pubDate=>'+time4+extra;
                }
                else{
                    k = url+'partial/'+ category+'/list/?fields=city&q_city='+city+'&pubDate&q_pubDate=>'+time4;
                }

                this.set('route.path', k);

            },





            ready: function() {



            },
            attached:function(){
//                this.set('route.path', '/');

                var extra =Polymer.dom(this).querySelectorAll('[filter-field]');

                console.log(extra);
                this.extraFields = extra;



            }

        });
    }());
</script>
